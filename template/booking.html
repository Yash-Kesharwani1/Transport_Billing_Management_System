{% include "header.html" %}
<div class="body-wrapper-inner">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-9">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h4 class="card-title mb-4 text-center">Add Booking</h4>
                        <form action="/save_booking/" method="post">
                            {% csrf_token %}
                            <div class="row">

                                <!-- Booking Number -->
                                <div class="col-md-6 mb-3">
                                    <label for="booking_number" class="form-label">Booking Number</label>
                                    <input type="text" name="booking_number" id="booking_number" class="form-control">
                                </div>

                                <!-- Booking Date -->
                                <div class="col-md-6 mb-3">
                                    <label for="booking_date" class="form-label">Booking Date</label>
                                    <input type="date" class="form-control" id="booking_date" name="booking_date">
                                </div>

                                <script>
                                    const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
                                    document.getElementById('booking_date').value = today; // Set it as the default value
                                </script>

                                <!-- Party -->
                                <div class="col-md-6 mb-3">
                                    <label for="party" class="form-label">Select Party</label>
                                    <select name="party" id="party" class="form-control" onchange="findPendigAmount()">
                                        <option value="selected" disabled selected>Selected</option>
                                        {% for party in partys %}
                                        <option value="{{party.id}}">{{party.party_name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Vehicle Type -->
                                <div class="col-md-6 mb-3">
                                    <label for="vehicle_type" class="form-label">Select Vehicle Type</label>
                                    <select name="vehicle_type" id="vehicle_type" class="form-control"
                                        onchange="findVehicle()">
                                        <option value="selected" disabled selected>Selected</option>
                                        {% for vehicle_type in vehicle_types %}
                                        <option value="{{vehicle_type.id}}">{{vehicle_type.vehicle_type}}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Vehicle -->
                                <div class="col-md-6 mb-3">
                                    <label for="vehicle" class="form-label">Select Vehicle</label>
                                    <select name="vehicle" id="vehicle_box" class="form-control" onchange="findVehiclePendigAmount()">
                                        <option value="selected" disabled selected>Selected</option>
                                    </select>
                                </div>

                                <!-- From City -->
                                <div class="col-md-6 mb-3">
                                    <label for="from_city" class="form-label">Select From City</label>
                                    <input type="text" name="from_city" id="from_city" class="form-control">
                                </div>

                                <!-- To City -->
                                <div class="col-md-6 mb-3">
                                    <label for="to_city" class="form-label">Select To City</label>
                                    <input type="text" name="to_city" id="to_city" class="form-control">
                                </div>

                                <!-- Loading & Unloading Dates -->
                                <div class="col-md-6 mb-3">
                                    <label for="loading_date" class="form-label">Loading Date</label>
                                    <input type="date" class="form-control" id="loading_date" name="loading_date">
                                </div>

                                <script>
                                    // Get today's date in YYYY-MM-DD format
                                    document.getElementById('loading_date').value = today; // Set it as the default value
                                </script>

                                <div class="col-md-6 mb-3">
                                    <label for="unloading_date" class="form-label">Unloading Date</label>
                                    <input type="date" class="form-control" id="unloading_date" name="unloading_date">
                                </div>

                                <!-- Financial Fields -->
                                <div class="col-md-6 mb-3">
                                    <label for="total_hire" class="form-label">Total Hire</label>
                                    <input type="number" class="form-control" id="total_hire" name="total_hire"
                                        onchange="[findSubTotal(),findBalance()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="advance_amount" class="form-label">Advance Amount</label>
                                    <input type="number" class="form-control" id="advance_amount" name="advance_amount"
                                        oninput="[findSubTotal(),findBalance()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="cash" class="form-label">Cash</label>
                                    <input type="number" class="form-control" id="cash" name="cash" value="0">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="online" class="form-label">Online</label>
                                    <input type="number" class="form-control" id="online" name="online" value="0">
                                </div>

                                <div id="transaction-fields" style="display: none;">
                                    <div class="col-md-6 mb-3">
                                        <label for="utr" class="form-label">UTR Number</label>
                                        <input type="text" class="form-control" id="utr" name="utr"
                                            placeholder="Eg. 4585568168323">
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="transaction_id" class="form-label">Transaction ID</label>
                                        <input type="text" class="form-control" id="transaction_id"
                                            name="transaction_id" placeholder="Eg. T456548615318768546">
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="balance_amount" class="form-label">Balance Amount</label>
                                    <input type="number" class="form-control" id="balance_amount" name="balance_amount"
                                        onchange="[findSubTotal(),findTotalPendiAmount()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="commission" class="form-label">Commission</label>
                                    <input type="number" class="form-control" id="commission" name="commission"
                                        onchange="[findSubTotal(),findTotalPendiAmount()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="local" class="form-label">Local</label>
                                    <input type="number" class="form-control" id="local" name="local"
                                        onchange="[findSubTotal(),findTotalPendiAmount()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="hamali" class="form-label">Hamali</label>
                                    <input type="number" class="form-control" id="hamali" name="hamali"
                                        onchange="[findSubTotal(),findTotalPendiAmount()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="st_charges" class="form-label">Service Tax Charges</label>
                                    <input type="number" class="form-control" id="st_charges" name="st_charges"
                                        onchange="[findSubTotal(),findTotalPendiAmount()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="tds" class="form-label">TDS</label>
                                    <input type="number" class="form-control" id="tds" name="tds"
                                        onchange="[findSubTotal(),findTotalPendiAmount()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="other_charges" class="form-label">Other Charges</label>
                                    <input type="number" class="form-control" id="other_charges" name="other_charges"
                                        onchange="[findSubTotal(), findTotalPendiAmount()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="remark" class="form-label">Remark</label>
                                    <input type="text" class="form-control" id="remark" name="remark">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="sub_total" class="form-label">Sub Total</label>
                                    <input type="number" class="form-control" id="sub_total" name="sub_total"
                                        onchange="findTotalPendiAmount()">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="previous_amount" class="form-label">Previous Amount</label>
                                    <input type="number" class="form-control" id="previous_amount"
                                        name="previous_amount" onchange="findTotalPendiAmount()">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="pending_amount" class="form-label">Pending Amount</label>
                                    <input type="number" class="form-control" id="pending_amount" name="pending_amount">
                                </div>


                                <div class="col-md-6 mb-3">
                                    <label for="total_hire_to_pay_to_vehicle" class="form-label">Total Amount To Pay To
                                        Owner</label>
                                    <input type="number" class="form-control" id="total_hire_to_pay_to_vehicle"
                                        name="total_hire_to_pay_to_vehicle"  onchange="[findBalanceToPayToOwner(),findTotalBalanceAmountToPayToVehicle()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="advance_amount_to_paid_to_vehicle" class="form-label">Advance Amount
                                        Paid To Owner</label>
                                    <input type="number" class="form-control" id="advance_amount_to_paid_to_vehicle"
                                        name="advance_amount_to_paid_to_vehicle" onchange="[findBalanceToPayToOwner(),findTotalBalanceAmountToPayToVehicle()]">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="balance_amount_to_pay_to_vehicle" class="form-label">Balance Amount To
                                        Pay To Owner</label>
                                    <input type="number" class="form-control" id="balance_amount_to_pay_to_vehicle"
                                        name="balance_amount_to_pay_to_vehicle" >
                                </div>
                            </div>

                            <!-- get vehicle previour pending amount -->
                            <input type="hidden" name="amount_to_send_vehicle_owner" id="amount_to_send_vehicle_owner">

                            <!-- get total total_balance_amount_to_send_to_vehicle_owner -->
                            <input type="hidden" name="total_balance_amount_to_send_to_vehicle_owner" id="total_balance_amount_to_send_to_vehicle_owner">

                            <!-- Submit Button -->
                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-primary">Add Booking</button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
            <h4 class="mt-5 text-center">Booking Details Table</h4>
            <div class="table-responsive">
                <table class="table table-bordered mt-3">
                    <thead class="table-light">
                        <tr>
                            <th>Action</th>
                            <th>Sr. No.</th>
                            <th>Booking Number</th>
                            <th>Booking Date</th>
                            <th>Party</th>
                            <th>Vehicle</th>
                            <th>Loading Date</th>
                            <th>Un-loading Date</th>
                            <th>From City</th>
                            <th>To City</th>
                            <th>Total Hire</th>
                            <th>Advance Amount</th>
                            <th>Balance Amount</th>
                            <th>Commission</th>
                            <th>Cash</th>
                            <th>Online</th>
                            <th>Transaction ID</th>
                            <th>UTR</th>
                            <th>Local</th>
                            <th>Hamali</th>
                            <th>TDS</th>
                            <th>ST Charges</th>
                            <th>Other Charges</th>
                            <th>Remark</th>
                            <th>Sub-Total</th>
                            <th>Previous Amount</th>
                            <th>Pending Amount</th>
                            <th>Total Amount To Pay to Vehicle Owner</th>
                            <th>Advance Amount Paid to Vehicle Owner</th>
                            <th>Balance Amount to Pay to Vehicle Owner</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td>
                                <a href="/edit_booking/?id={{booking.id}}"><button class="btn">Edit</button></a>
                                <a href="/delete_booking/?id={{booking.id}}"><button class="btn">Delete</button></a>
                            </td>
                            <td>{{forloop.counter}}</td>
                            <td>{{ booking.booking_number }}</td>
                            <td>{{ booking.booking_date }}</td>
                            <td>{{ booking.party }}</td>
                            <td>{{ booking.vehicle }}</td>
                            <td>{{ booking.loading_date }}</td>
                            <td>{{ booking.unloading_date }}</td>
                            <td>{{ booking.from_city }}</td>
                            <td>{{ booking.to_city }}</td>
                            <td>{{ booking.total_hire }}</td>
                            <td>{{ booking.advance_amount }}</td>
                            <td>{{ booking.balance_amount }}</td>
                            <td>{{ booking.commission }}</td>
                            <td>{{ booking.cash }}</td>
                            <td>{{ booking.online }}</td>
                            <td>{{ booking.transaction_id }}</td>
                            <td>{{ booking.utr }}</td>
                            <td>{{ booking.local }}</td>
                            <td>{{ booking.hamali }}</td>
                            <td>{{ booking.tds }}</td>
                            <td>{{ booking.st_charges }}</td>
                            <td>{{ booking.other_charges }}</td>
                            <td>{{ booking.remark }}</td>
                            <td>{{ booking.sub_total }}</td>
                            <td>{{ booking.previous_amount }}</td>
                            <td>{{ booking.pending_amount }}</td>
                            <td>{{ booking.total_hire_to_pay_to_vehicle }}</td>
                            <td>{{ booking.advance_amount_to_paid_to_vehicle }}</td>
                            <td>{{ booking.balance_amount_to_pay_to_vehicle }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>

    // This is not working
    function findBalanceToPayToOwner() {
        var total_hire = parseFloat(document.getElementById("total_hire_to_pay_to_vehicle").value) || 0;
        var advance_amount = parseFloat(document.getElementById("advance_amount_to_paid_to_vehicle").value) || 0;
        var balance_amount = total_hire - advance_amount;
        document.getElementById("balance_amount_to_pay_to_vehicle").value = balance_amount;
    }

    // This is not working
    function findBalance() {
        var total_hire = parseFloat(document.getElementById("total_hire").value) || 0;
        var advance_amount = parseFloat(document.getElementById("advance_amount").value) || 0;
        var balance_amount = total_hire - advance_amount;
        document.getElementById("balance_amount").value = balance_amount;
    }

    function findSubTotal() {
        var total_hire = parseFloat(document.getElementById("total_hire").value) || 0;
        var advance_amount = parseFloat(document.getElementById("advance_amount").value) || 0;
        var commission = parseFloat(document.getElementById("commission").value) || 0;
        var local = parseFloat(document.getElementById("local").value) || 0;
        var hamali = parseFloat(document.getElementById("hamali").value) || 0;
        var st_charges = parseFloat(document.getElementById("st_charges").value) || 0;
        var tds = parseFloat(document.getElementById("tds").value) || 0;
        var other_charges = parseFloat(document.getElementById("other_charges").value) || 0;

        var sub_total = total_hire + commission + local + hamali + st_charges + tds + other_charges;
        console.log("total_hire value:", document.getElementById("total_hire"));


        document.getElementById("sub_total").value = sub_total; // Optional: round to 2 decimals
    }


    function findVehicle() {
        var vehicle_type_id = document.getElementById("vehicle_type").value;
        $.ajax({ "url": "/get_all_vehicle/?id=" + vehicle_type_id }).done(
            function (result) {

                // console.log(result.citys);

                var vehicles = result.vehicles;
                var row = '';
                for (var i = 0; i < vehicles.length; i++) {
                    row = row + '<option value="' + vehicles[i].id + '">' + vehicles[i].vehicle_number +'-'+ vehicles[i].owner + '</option>';
                }
                print(row)
                // console.log(row);
                document.getElementById('vehicle_box').innerHTML = row;
            }
        );
    }

    function findPendigAmount() {
        var party_id = document.getElementById('party').value;
        $.ajax({

            url: "/get_previous_amount/?id=" + party_id
        }).done(function (result) {
            var previous_amount = result.party.pending_amount || 0;
            document.getElementById('previous_amount').value = previous_amount;
            // console.log(result.owner);
            console.log(result);
        });
    }

    function findTotalPendiAmount() {
        var sub_total = parseInt(document.getElementById('sub_total').value) || 0;
        var previous_amount = parseInt(document.getElementById('previous_amount').value) || 0;
        var advance_amount = parseInt(document.getElementById('advance_amount')) || 0;
        var pending_amount = sub_total + previous_amount;
        document.getElementById('pending_amount').value = pending_amount;
    }

    function toggleTransactionFields() {
        const onlineAmount = parseFloat(document.querySelector('input[name="online"]').value) || 0;
        const txnFields = document.getElementById('transaction-fields');

        txnFields.style.display = onlineAmount > 0 ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const onlineInput = document.querySelector('input[name="online"]');
        onlineInput.addEventListener('input', toggleTransactionFields);
        toggleTransactionFields();  // initial call
    });

    function findVehiclePendigAmount() {
        var vehicle_id = document.getElementById('vehicle_box').value;
        $.ajax({

            url: "/get_previous_amount_to_send_vehicle_owner/?id=" + vehicle_id
        }).done(function (result) {
            var previous_amount = result.vehicle.pending_amount || 0;
            document.getElementById('amount_to_send_vehicle_owner').value = previous_amount;
            // console.log(result.owner);
            console.log(result);
        });
    }

    function findTotalBalanceAmountToPayToVehicle(){
        var a = parseInt(document.getElementById('amount_to_send_vehicle_owner').value) || 0;
        var b = parseInt(document.getElementById('balance_amount_to_pay_to_vehicle').value) ||0;
        var c = a + b;
        document.getElementById('total_balance_amount_to_send_to_vehicle_owner').value = c;

    }
</script>
{% include 'footer.html' %}